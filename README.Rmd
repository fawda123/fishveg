---
title: "README"
output:
  html_document:
    keep_md: yes
    toc: no
    self_contained: yes
---

```{r echo = F, message = F, warning = F}
library(tidyr)
library(ggplot2)
library(purrr)
library(dplyr)
library(stargazer)
library(ggord)
library(vegan)
source('R/funcs.R')
```

#### Files

All data created in `R\dat_proc.R`.  Source data in the ignore folder were created elsewhere.

* `fish_dat.RData` DNR CPUE fisheries data, one row per fish.  Months are June through September, standard population assessments and re-surveys.  Sampling gear are gillnet, trapnets, beach seines (15, 50 ft), and backpack electrofishing.

* `fishveg_dat.RData` combined fisheries and veg data, fish data as total richness, veg data summarized by total rich and subm rich for each lake.  Fish and veg data combined if the survey was in the same year and a fisheries survey had all three sampling types (gillnet, trapnet, nearshore seine/electrofishing). Covariates for each lake include UTM coordinates, ecoregion, Strahler stream order out, watershed area, lake depth, lake area, percent human development in watershed, SDI, stream length in upper watershed, and secchi depth.  

* `map_dat.RData` Several R objects for creating plots. 

* `veg_dat.RData` DNR veg transect data from 1992 to present. Format is dow, date, transect, species, and abundance category.  NULL abundance entries are not removed, these are species in the survey but not observed on a transect.  Note that there were no lakes in the dataset that had zero veg.  

#### Exploratory analysis

```{r fig.height = 7, fig.width = 7, echo = F, message = F, cache = T, warning = F}

library(tidyverse)
library(maptools)
library(gridExtra)
library(grid)
library(RColorBrewer)
load(file = 'data/map_dat.RData')

######
# maps

# get legend from an existing ggplot object
g_legend <- function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

# format data for ggplot
state <- fortify(state)
ecoregs <- fortify(ecoregs)
counties <- fortify(counties)
ecoregs <- ecoregs[ecoregs$id %in% c(2, 3, 4), ]
ecoregs$Ecoregion <- factor(ecoregs$id, levels = c(2, 3, 4), 
  labels = c("NF", "ETF", "GP"))

# format fish data to same scale
fishbrks <- c(0, 5, 10, 15, 20, Inf)
fishlabs <- c('<= 5',  '<= 10', '<= 15', '<= 20', '> 20')
vegbrks <- c(0, 10, 20, 30, 40, Inf)
veglabs <- c('<= 10',  '<= 20', '<= 30', '<= 40', '> 40')
toplo <- select(fishveg_dat, utmx, utmy, fish_rich, veg_rich) %>% 
  mutate(
    fish_rich = cut(fish_rich, breaks = fishbrks, labels = fishlabs),
    veg_rich = cut(veg_rich, breaks = vegbrks, labels = veglabs)
    )

# legend labels, color palette
fishleglabs <- list(expression(phantom('')<=5), expression(phantom('')<=10), expression(phantom('')<=15), expression(phantom('')<=20), expression(phantom('')>20))
vegleglabs <- list(expression(phantom('')<=10), expression(phantom('')<=20), expression(phantom('')<=30), expression(phantom('')<=40), expression(phantom('')>40))
cols <- colorRampPalette(c('darkgrey', 'black'))(length(fishleglabs))

# carp cpue GN
p1 <- ggplot(state, aes(x = long, y = lat)) + 
  geom_polygon(data = counties, aes(x = long, y = lat, group = group), 
    fill = NA, colour = 'grey') +
  geom_polygon(data = ecoregs, aes(x = long, y = lat, group = group, fill= Ecoregion),  
    alpha = 0.5) +
  geom_polygon(fill = NA, colour = 'black') +
  geom_point(data = toplo, aes(x = utmx, y = utmy, size = fish_rich, color = fish_rich), alpha = 0.8) +
  scale_size_discrete('Fish richness', range = c(1, 8), labels = fishleglabs) + 
  scale_colour_manual('Fish richness', values = cols, labels = fishleglabs) +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank(), 
          legend.box.just = 'right'
    ) +
  coord_equal()

# save
# tiff('fig1.tif', height = 7, width = 7, units = 'in', compression = 'lzw', res = 300, family = 'serif')
p1
# dev.off()

p2 <- ggplot(state, aes(x = long, y = lat)) + 
  geom_polygon(data = counties, aes(x = long, y = lat, group = group), 
    fill = NA, colour = 'grey') +
  geom_polygon(data = ecoregs, aes(x = long, y = lat, group = group, fill= Ecoregion),  
    alpha = 0.5) +
  geom_polygon(fill = NA, colour = 'black') +
  geom_point(data = toplo, aes(x = utmx, y = utmy, size = veg_rich, color = veg_rich), alpha = 0.8) +
  scale_size_discrete('Veg richness', range = c(1, 8), labels = vegleglabs) + 
  scale_colour_manual('Veg richness', values = cols, labels = vegleglabs) +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank(), 
          legend.box.just = 'right'
    ) +
  coord_equal()

# save
# tiff('fig2.tif', height = 7, width = 7, units = 'in', compression = 'lzw', res = 300, family = 'serif')
p2
# dev.off()
```

Plant and fish richness vs potential explanatory variables, separated by ecoregion.
```{r fig.height = 8, fig.width = 12, echo = F, message = F, cache = T, warning = F}

######
# diagnostic plots
data(map_dat)

# format data
toplo <- select(fishveg_dat, 
  veg_rich, fish_rich, secchim, phuman, aream2, shedaream2, strmlgthm, ecoreg
  ) %>% 
  mutate(
    ecoreg = factor(ecoreg, levels = c('northern forests', 'eastern temperate forests', 'great plains'), labels = c('NF', 'ETF', 'GP'))
  ) 
toplo1 <- gather(toplo, 'var', 'val', -veg_rich, -ecoreg)
toplo2 <- gather(toplo, 'var', 'val', -fish_rich, -ecoreg)
toplo3 <- gather(toplo, 'var', 'val', -ecoreg)
  
# create plot
p3 <- ggplot(toplo1, aes(x = val, y = veg_rich, fill = ecoreg, colour = ecoreg)) + 
  geom_point(pch = 21, alpha = 0.8) + 
  scale_x_log10('Value, log10') +
  scale_y_continuous('Plant richness', expand = c(0, 0)) + 
  stat_smooth(method ='lm', colour = 'black', se = TRUE) + 
  facet_wrap(ecoreg ~ var, ncol = 6, scales = 'free_x') + 
  theme_bw() + 
  theme(
    legend.position = 'none',
    strip.background = element_rect(fill = "white")
    )
p4 <- ggplot(toplo2, aes(x = val, y = fish_rich, fill = ecoreg, colour = ecoreg)) + 
  geom_point(pch = 21, alpha = 0.8) + 
  scale_x_log10('Value, log10') +
  scale_y_continuous('Fish richness', expand = c(0, 0)) + 
  stat_smooth(method ='lm', colour = 'black', se = TRUE) + 
  facet_wrap(ecoreg ~ var, ncol = 6, scales = 'free_x') + 
  theme_bw() + 
  theme(
    legend.position = 'none',
    strip.background = element_rect(fill = "white")
    )

p5 <- ggplot(toplo3, aes(x = val, fill = ecoreg, colour = ecoreg)) + 
  geom_histogram() + 
  scale_x_log10('Value, log10') +
  facet_wrap(ecoreg ~ var, ncol = 7, scales = 'free_x') + 
  theme_bw() + 
  theme(
    legend.position = 'none',
    strip.background = element_rect(fill = "white")
    )

# save
# tiff('fig3.tif', height = 5, width = 12, units = 'in', compression = 'lzw', res = 300, family = 'serif')
p3
p4
p5
# dev.off()
```


