---
title: "README"
output:
  html_document:
    keep_md: yes
    toc: no
    self_contained: no
---

```{r echo = F, message = F, warning = F}
library(tidyr)
library(ggplot2)
library(purrr)
library(dplyr)
library(stargazer)
library(ggord)
library(vegan)
source('R/funcs.R')
```

#### Files

All data created in `R\dat_proc.R`.  Source data in the ignore folder were created elsewhere.

* `fish_all.RData` DNR trapnet/gillnet fish data for all years, months, and survey types.  Dat are one unique record per fish.  Carp, black bullhead, yellow bullhead, bluegill, black crappie, white crappie, yellow perch, northern pike, and walleye are identified, all other species labelled as 'other'. Total fish length is reported in mm. Data are only for July, August, September, all survey types. Includes true zeroes. 

* `fish_dat.RData` Same as `fish_all.RData` but data are converted to CPUE, surveys are Jul/Aug/Sep, and 'standard population assessments' and 'resurveys'.  CPUE is estimated as total fish weight (kg) divided by effort, unique to species, date, lake, and gear type.  CPUE was estimated separately for trapnet, gillnet. Length to weight equations were from the Handbook of Freshwater Fishery Biology. The arguments to `cpue_fun` show the species and gear type combos, including parameters for length/weight conversions.  Bullhead are black and yellow bullhead combined, and crappie are white and black crappie combined. Species are not separated by adult or yoy. 

* `fishveg_dat.RData` combined fisheries and veg data, veg data summarized by total rich and subm rich for each lake.  Fish and veg data combined if the survey was in the same year. Covariates for each lake include UTM coordinates, ecoregion, watershed area, lake depth, lake area, percent human development in watershed, SDI, and secchi depth.   

* `map_dat.RData` Several R objects for creating plots. 

* `veg_dat.RData` DNR veg transect data from 1992 to present. Format is dow, date, transect, species, and abundance category.  NULL abundance entries are not removed, these are species in the survey but not observed on a transect.  Note that there were no lakes in the dataset that had zero veg.  

#### Exploratory analysis

```{r fig.height = 7, fig.width = 7, echo = F, message = F, cache = T, warning = F}
library(tidyverse)
library(maptools)
library(gridExtra)
library(grid)
library(RColorBrewer)
load(file = 'data/map_dat.RData')

######
# maps

# get legend from an existing ggplot object
g_legend <- function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

# format data for ggplot
state <- fortify(state)
ecoregs <- fortify(ecoregs)
counties <- fortify(counties)
ecoregs <- ecoregs[ecoregs$id %in% c(2, 3, 4), ]
ecoregs$Ecoregion <- factor(ecoregs$id, levels = c(2, 3, 4), 
  labels = c("NF", "ETF", "GP"))

# format fish data to same scale
brks <- c(-Inf, 0, 1, 2, 5, 10, Inf)
labs <- c('0', '< 1',  '< 2', '< 5', '< 10', '> 10')
toplo <- select(fishdat, utmx, utmy, common.carp_GN, black.bullhead_TN) %>% 
  mutate(
    common.carp_GN = cut(common.carp_GN, breaks = brks, labels = labs),
    black.bullhead_TN = cut(black.bullhead_TN, breaks = brks, labels = labs)
    )

# legend labels, color palette
leglabs <- list(expression(0), expression(phantom('')<=1), expression(phantom('')<=2), expression(phantom('')<=5), expression(phantom('')<=10), expression(phantom('')>10))
cols <- colorRampPalette(c('darkgrey', 'black'))(length(leglabs))

# carp cpue GN
p1 <- ggplot(state, aes(x = long, y = lat)) + 
  geom_polygon(data = counties, aes(x = long, y = lat, group = group), 
    fill = NA, colour = 'grey') +
  geom_polygon(data = ecoregs, aes(x = long, y = lat, group = group, fill= Ecoregion),  
    alpha = 0.5) +
  geom_polygon(fill = NA, colour = 'black') +
  geom_point(data = toplo, aes(x = utmx, y = utmy, size = common.carp_GN, color = common.carp_GN), alpha = 0.8) +
  scale_size_discrete('Carp kg/net', range = c(2, 12), labels = leglabs) + 
  scale_colour_manual('Carp kg/net', values = cols, labels = leglabs) +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank(), 
          legend.box.just = 'right'
    ) +
  coord_equal()

# save
# tiff('fig1.tif', height = 7, width = 7, units = 'in', compression = 'lzw', res = 300, family = 'serif')
p1
# dev.off()
```
  
```{r fig.height = 7, fig.width = 7, echo = F, message = F, cache = T, warning = F}
# black bullhead CPUE TN
p2 <- ggplot(state, aes(x = long, y = lat)) + 
  geom_polygon(data = counties, aes(x = long, y = lat, group = group), 
    fill = NA, colour = 'grey') +
  geom_polygon(data = ecoregs, aes(x = long, y = lat, group = group, fill= Ecoregion),  
    alpha = 0.5) +
  geom_polygon(fill = NA, colour = 'black') +
  geom_point(data = toplo, aes(x = utmx, y = utmy, size = black.bullhead_TN, color = black.bullhead_TN), alpha = 0.8) +
  scale_size_discrete('Bull kg/net', range = c(2, 12), labels = leglabs) + 
  scale_colour_manual('Bull kg/net', values = cols, labels = leglabs) +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank(), 
          legend.box.just = 'right'
    ) +
  coord_equal()

# save
# tiff('fig2.tif', height = 7, width = 7, units = 'in', compression = 'lzw', res = 300, family = 'serif')
p2
# dev.off()
```

```{r fig.height = 5, fig.width = 12, echo = F, message = F, cache = T, warning = F}
######
# diagnostic plots
data(map_dat)

# format data
toplo <- select(fishdat, 
  S_rich, common.carp_GN, black.bullhead_TN, bluegill_TN, secchim, sdi, phuman, aream2, shedaream2, ecoreg
  ) %>% 
  mutate(
    common.carp_GN = 1 + common.carp_GN, 
    black.bullhead_TN = 1 + black.bullhead_TN, 
    bluegill_TN = 1 + bluegill_TN,
    ecoreg = factor(ecoreg, levels = c('eastern temperate forests', 'great plains'), labels = c('ETF', 'GP'))
  ) %>% 
  gather('var', 'val', -S_rich, -ecoreg)
  
# create plot
p3 <- ggplot(toplo, aes(x = val, y = S_rich, fill = ecoreg, colour = ecoreg)) + 
  geom_point(pch = 21, alpha = 0.8) + 
  scale_x_log10('Value, log10') +
  scale_y_continuous('Plant richness', expand = c(0, 0)) + 
  stat_smooth(method ='lm', colour = 'black', se = TRUE) + 
  facet_wrap(ecoreg ~ var, ncol = 8, scales = 'free_x') + 
  theme_bw() + 
  theme(
    legend.position = 'none',
    strip.background = element_rect(fill = "white")
    )

# save
# tiff('fig3.tif', height = 5, width = 12, units = 'in', compression = 'lzw', res = 300, family = 'serif')
p3
# dev.off()
```

```{r warning = F, message = F}
data(map_dat)

dat <- select(fishdat, 
  S_rich, common.carp_GN, black.bullhead_TN, bluegill_TN, secchim, sdi, phuman, aream2, shedaream2
  ) %>% 
  mutate(
    CAP = as.character(1 * (common.carp_GN > 0)),
    BHD = as.character(1 * (black.bullhead_TN > 0))
  ) %>% 
  unite(fish_cat, BHD, CAP) %>% 
  mutate(
    fish_cat = factor(fish_cat, 
      levels = c('1_1', '1_0', '0_1', '0_0'),
      labels = c('BHD_CAP', 'BHD_only', 'CAP_only', 'none')
      )
    ) %>% 
  select(-common.carp_GN, -black.bullhead_TN)
lks <- dat$fish_cat
dat <- select(dat, -fish_cat) %>%
  decostand(dat, method = 'log', logbase = 10)

# pca  
pcamod <- prcomp(dat)

# tiff('fig4.tif', height = 6, width = 8, units = 'in', compression = 'lzw', res = 300, family = 'serif')
ggord(pcamod, lks, vec_ext = 3, size = 3, alpha = 0.8)
dev.off()

# nms
nmsmod <- metaMDS(dat, distance = 'bray', trace = 0, autotransform = F, k = 2)

tiff('fig5.tif', height = 6, width = 8, units = 'in', compression = 'lzw', res = 300, family = 'serif')
ggord(nmsmod, lks, size = 3, alpha = 0.8)
# dev.off()
```